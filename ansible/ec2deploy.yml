- name: deploy to ec2
  hosts: localhost
  connection: local

  tasks:
   - name: Launch ec2 instance
     ec2:
      instance_type: t2.micro
      image: ami-085925f297f89fce1
      region: us-east-1
      key_name: presentation
      vpc_subnet_id: subnet-020af364
      assign_public_ip: yes
      wait: yes
      count: 1
      group: eshop
      aws_access_key: "ASIAR2D6UJOZLJEUM6CH"
      aws_secret_key: "69+5FoXYTupbhpxq/ZcDE3nCgBPAtqFUCTMcOUT5"
      security_token: "FwoGZXIvYXdzEFEaDHlhlHB9VTmaWWZOASK8AXPfZSSV33Afax2YsPMh8EOOdPoY8QibOVKaK5pPfSExPU/Z0oQ+kLQ+JHo2gl2M//mrNLPkSogKCJOd/LAs07Qsu97aGgIKwKqWY0SIDQ/WJDUn/bvrbT7jl2wjq9jZUszU7pcfWNJHVfoH/l4cwAugrjUx0XY5fdQohW8pjUxNqwMW6PnGn+3GOAMfGU0Kd//QBomAKchoh4sCq3KFY6B0IAE/E3MKIB0Ng0tsmj7TykwS3LqU4xBa6m1bKJSX+fUFMi3rt8W8iQkJ1r/r5eq2bUCgTl5UMvVblt3q32XP7G+IFwIKzpGDEqwwwRyn0SM="
     register: ec2

   - name: Add instance host to group
     add_host: hostname={{item.public_dns_name}} groupname=launched
     with_items: '{{ec2.instances}}'

   - name: Wait for SSH connection
     wait_for: host={{item.public_dns_name}} port=22 delay=30 timeout=300 state=started
     with_items: '{{ec2.instances}}'

- name: Configure ec2
  hosts: launched
  connection: ssh

  tasks:
   - name: Install docker
     apt:
      name: docker.io
      state: present
      update_cache: yes
     become: yes
   - service:
      name: docker
      state: started
      enabled: yes
     become: yes
   - name: Get project from git
     git:
      repo : 'https://github.com/jakmol/4IT572_Eshop'
      dest: ./app
     become: yes
   - name: Build docker with eshop
     shell: cd app && docker build -t myeshop:latest .
     become: yes
   - name: Run docker with eshop
     shell: docker run -p 80:3000 myeshop
     async: 45
     poll: 10
     become: yes
   - wait_for:
      port: 80  
