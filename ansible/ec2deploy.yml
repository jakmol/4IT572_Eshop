- name: deploy to ec2
  hosts: localhost
  connection: local

  tasks:
   - name: Launch ec2 instance
     ec2:
      instance_type: t2.micro
      image: ami-085925f297f89fce1
      region: us-east-1
      key_name: presentation
      vpc_subnet_id: subnet-020af364
      assign_public_ip: yes
      wait: yes
      count: 1
      group: eshop
      aws_access_key: "ASIAR2D6UJOZNAASIT7H"
      aws_secret_key: "MJZYZfpa7Jh9Km4UnlAihGw9GeuRGnXyoyDg1FTv"
      security_token: "FwoGZXIvYXdzEEEaDK9Lybqip5tso2GnUyK8AbyjHldAK1WPsdd6FmHWaDqydwcyizhQPZylHkOSf4YxzM9BO1bwq1iE+aomBmOTF9/6eP/o1fCStuI9dBTYG77sFil2Il7iQK0BAS7IwHdUMhQbSsuTvY7YtQf67ZGToPiqhrEEePSMHC3qK753EZWM9XAG7zL6+bQnenvgckJWN11Y2XgUGRqUWajftjbbAAs3f207EY8k6HZVT2MulGbr6c5oclgfdCNgkdDa/M4cIwlkK1x69S8QfRE1KLTS9fUFMi2Lv5CS0q7ZUwyqF/9MhdGAoyF5e+6EGUv2ZDNUgOHa/kedi1vJUv0Zzs0nXrU="
     register: ec2

   - name: Add instance host to group
     add_host: hostname={{item.public_dns_name}} groupname=launched
     with_items: '{{ec2.instances}}'

   - name: Wait for SSH connection
     wait_for: host={{item.public_dns_name}} port=22 delay=30 timeout=300 state=started
     with_items: '{{ec2.instances}}'

- name: Configure ec2
  hosts: launched
  connection: ssh

  tasks:
   - name: Install docker
     apt:
      name: docker.io
      state: present
      update_cache: yes
     become: yes
   - service:
      name: docker
      state: started
      enabled: yes
     become: yes
   - name: Get project from git
     git:
      repo : 'https://github.com/jakmol/4IT572_Eshop'
      dest: ./app
     become: yes
   - name: Build docker with eshop
     shell: cd app && docker build -t myeshop:latest .
     become: yes
   - name: Run docker with eshop
     shell: docker run -p 80:3000 myeshop
     async: 45
     poll: 10
     become: yes
   - wait_for:
      port: 80  
